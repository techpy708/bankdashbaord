{% extends "base.html" %}

{% block content %}

<style>
    /* === Dashboard Overview === */
.container {
  max-width: 1200px;
}

/* Title */
.container h2 {
  font-weight: 700;
  color: #1e293b; /* slate-800 */
  font-size: 1.8rem;
  margin-bottom: 2rem;
  letter-spacing: -0.5px;
}

/* Filter form */
form.form-inline {
  background: #f9fafb;
  padding: 1rem 1.5rem;
  border-radius: 0.75rem;
  box-shadow: 0 3px 6px rgba(0,0,0,0.05);
}

form.form-inline label {
  font-weight: 500;
  margin-right: 0.4rem;
  color: #374151;
}

form.form-inline .form-control {
  border-radius: 0.5rem;
  border: 1px solid #d1d5db;
  min-width: 180px;
  transition: all 0.2s ease-in-out;
}

form.form-inline .form-control:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
}

/* Clear button */
#clearFiltersBtn {
  border-radius: 0.5rem;
  font-weight: 500;
  transition: background 0.2s ease-in-out;
}

#clearFiltersBtn:hover {
  background: #4b5563; /* gray-700 */
  color: #fff;
}

/* Cards */
.card {
  transition: all 0.2s ease-in-out;
  border-radius: 1rem !important;
  border: none !important;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.08) !important;
}

.card-body i {
  display: inline-block;
  padding: 0.7rem;
  border-radius: 50%;
  background: #f3f4f6;
}

.card-title {
  font-size: 1rem !important;
  color: #374151;
  font-weight: 600 !important;
}

.card-text {
  font-size: 2rem !important;
  font-weight: 700 !important;
}

/* Icon color tweaks for better contrast */
.text-primary {
  color: #2563eb !important;
}

.text-warning {
  color: #d97706 !important;
}

.text-success {
  color: #059669 !important;
}

.text-danger {
  color: #dc2626 !important;
}

.text-info {
  color: #0ea5e9 !important;
}

</style>

<div class="container mt-5">
    <h2 class="mb-4 font-weight-bold text-center text-primary">Dashboard Overview</h2>

    <!-- Filter Form -->
    <form method="get" class="form-inline justify-content-center mb-4">
        <div class="form-group mr-3 mb-2">
            <label for="branch_code" class="mr-2">Branch</label>
            <select id="branch_code" name="branch_code" class="form-control">
                <option value="">All Branches</option>
                {% for branch in all_branches %}
                <option value="{{ branch }}" {% if branch == branch_filter %}selected{% endif %}>{{ branch }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mr-3 mb-2">
            <label for="department" class="mr-2">Department</label>
            <select id="department" name="department" class="form-control">
                <option value="">All Departments</option>
                {% for dept in all_departments %}
                <option value="{{ dept }}" {% if dept == department_filter %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
        </div>

        
        <div class="form-group mr-3 mb-2">
            <label for="financial_year" class="mr-2">Financial Year</label>
            <input type="text" 
                  name="financial_year" 
                  id="financial_year" 
                  class="form-control"   
                  placeholder="YYYY-YYYY" 
                  pattern="^\d{4}-\d{4}$" 
                  value="{{ financial_year_filter  }}">
        </div>


        <button type="button" class="btn btn-secondary mb-2 ml-2" id="clearFiltersBtn">Clear</button>
    </form>

    <div class="row">
        <!-- Unique Branch Codes -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100">
                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-code-branch fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">Total Branches</h5>
                    <p class="card-text font-weight-bold text-primary mb-0" style="font-size: 2.5rem;">{{ total_unique_branch_codes }}</p>
                </div>
            </div>
        </div>


        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100">
                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-users fa-2x text-info"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">Total Users</h5>
                    <p class="card-text font-weight-bold text-info mb-0" style="font-size: 2.5rem;">{{ total_users }}</p>
                </div>
            </div>
        </div>

        <!-- Total Departments -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable"
            data-url="{% url 'view_observations' %}?department=">

            <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-building fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">Total Departments</h5>
                    <p class="card-text font-weight-bold text-warning mb-0" style="font-size: 2.5rem;">{{ total_departments }}</p>
                </div>
            </div>
        </div>

        <!-- Open Observations -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable"
            data-url="{% url 'view_observations' %}?status=OPEN">

            <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-folder-open fa-2x text-danger"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">Open Observations</h5>
                    <p class="card-text font-weight-bold text-danger mb-0" style="font-size: 2.5rem;">{{ total_open }}</p>
                </div>
            </div>
        </div>

        <!-- Closed Observations -->
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable"
              data-url="{% url 'view_observations' %}?status=CLOSED">

              <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">Closed Observations</h5>
                    <p class="card-text font-weight-bold text-success mb-0" style="font-size: 2.5rem;">{{ total_closed }}</p>
                </div>
            </div>
        </div>


         
        

        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable" 
                data-url="{% url 'view_observations' %}?risk_category=High">

                <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1">High Risk</h5>
                    <p class="card-text font-weight-bold text-danger mb-0">{{ total_high_risk }}</p>
                </div>
            </div>
        </div>


        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable" 
                data-url="{% url 'view_observations' %}?risk_category=Medium">

                <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1">Medium Risk</h5>
                    <p class="card-text font-weight-bold text-warning mb-0">{{ total_medium_risk }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card shadow-sm rounded-lg border-0 py-3 px-2 h-100 card-clickable" 
                data-url="{% url 'view_observations' %}?risk_category=Low">

                <span class="position-absolute top-0 start-0 m-2 badge bg-secondary">Info</span>

                <div class="card-body d-flex flex-column justify-content-center text-center p-2">
                    <div class="mb-2">
                        <i class="fas fa-exclamation-triangle fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title font-weight-bold mb-1">Low Risk</h5>
                    <p class="card-text font-weight-bold text-success mb-0">{{ total_low_risk }}</p>
                </div>
            </div>
        </div>



        
  

   


        
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const filterForm = document.querySelector('form.form-inline');
    const selects = filterForm ? filterForm.querySelectorAll('select') : [];

    // Submit form on select change
    selects.forEach(select => {
        select.addEventListener('change', () => {
            if (filterForm) filterForm.submit();
        });
    });

    // Auto-submit on year input change
    const yearInput = document.getElementById('financial_year');
    if (yearInput) {
        yearInput.addEventListener('change', () => {
            if (filterForm) filterForm.submit();
        });
    }


    // Clear filters button
    const clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            selects.forEach(select => select.selectedIndex = 0);
            if (filterForm) filterForm.submit();
        });
    }

    // Card click handling
    document.querySelectorAll('.card-clickable').forEach(card => {
    card.addEventListener('click', () => {
        const url = card.dataset.url;
        if (!url) return;

        const baseUrl = url.split('?')[0];
        const params = new URLSearchParams(url.split('?')[1] || '');

        // Append branch/department filters only if they are selected
        const filterForm = document.querySelector('form.form-inline');
        const selects = filterForm ? filterForm.querySelectorAll('select') : [];
        selects.forEach(select => {
            if (select.value) {
                params.set(select.name, select.value);
            }
        });

        // ✅ Add financial year
        const yearInput = document.getElementById('financial_year');
        if (yearInput && yearInput.value) {
            params.set(yearInput.name, yearInput.value);
        }
        

        // Redirect using risk_category + any selected filters
        window.location.href = `${baseUrl}?${params.toString()}`;
    });


  });

});
</script>

{% endblock %}

